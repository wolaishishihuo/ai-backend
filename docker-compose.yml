version: '3.8'

services:
  # ============================================
  # 数据库迁移服务（一次性执行）
  # ============================================
  migrate:
    image: ai-backend:latest
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: ai-migrate
    command: ["npx", "prisma", "migrate", "deploy"]
    environment:
      NODE_ENV: production
      MYSQL_DATABASE_URL: mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@host.docker.internal:3306/${DATABASE_NAME}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - ai-network
    restart: 'no'

  # ============================================
  # 后端 API 服务
  # ============================================
  backend:
    image: ai-backend:latest
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: ai-backend
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      # Prisma 数据库连接 URL（推荐使用环境变量）
      MYSQL_DATABASE_URL: mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@host.docker.internal:3306/${DATABASE_NAME}
      # 数据库配置（用于其他用途）
      DATABASE_HOST: host.docker.internal
      DATABASE_PORT: 3306
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      # API 密钥
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      # CORS 配置
      CORS_ORIGIN: ${CORS_ORIGIN}
      # 邮件服务配置
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-AI系统}
      # Redis 配置（可选，不配置则禁用）
      REDIS_HOST: ${REDIS_HOST:-}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_SENTINELS: ${REDIS_SENTINELS:-}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - ai-network
    # 日志配置
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # ============================================
  # Redis 缓存服务
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: ai-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    networks:
      - ai-network
    # 数据持久化（可选）
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

networks:
  ai-network:
    driver: bridge

volumes:
  redis-data:
