version: '3.8'

services:
  # ============================================
  # MySQL 和 Redis - 使用宝塔已有的服务
  # ============================================

  # ============================================
  # 后端 API 服务
  # ============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: ai-backend
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      MYSQL_DATABASE_URL: mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@host.docker.internal:3306/${DATABASE_NAME}
      DATABASE_HOST: host.docker.internal
      DATABASE_PORT: 3306
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
      # Redis 暂未使用，不配置则自动禁用
      # REDIS_HOST: host.docker.internal
      # REDIS_PORT: 6379
      # REDIS_DB: 0
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: 7d
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      CORS_ORIGIN: ${CORS_ORIGIN}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ai-network

  # ============================================
  # 前端静态服务 - 已通过宝塔 Nginx 配置，无需 Docker
  # ============================================

networks:
  ai-network:
    driver: bridge
